name: Inspect GitHub Package Size

on:
  workflow_dispatch:
    inputs:
      package-name:
        description: Name of the GitHub Package within this organization
        required: true

permissions:
  contents: read
  packages: read

jobs:
  download-and-measure:
    runs-on: ubuntu-latest
    steps:
      - name: Resolve package metadata and download tarball
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PACKAGE_NAME: ${{ inputs.package-name }}
          ORG: ${{ github.repository_owner }}
        run: |
          set -euo pipefail

          if [ -z "$PACKAGE_NAME" ]; then
            echo "Package name input is required." >&2
            exit 1
          fi

          tmp_versions="$(mktemp)"
          detected_type=""
          for candidate in container docker npm maven rubygems nuget generic; do
            if gh api "/orgs/${ORG}/packages/${candidate}/${PACKAGE_NAME}/versions?per_page=1" \
                > "$tmp_versions" 2>/dev/null; then
              if [ -s "$tmp_versions" ] && [ "$(jq 'length' "$tmp_versions")" -gt 0 ]; then
                detected_type="$candidate"
                break
              fi
            fi
          done

          if [ -z "$detected_type" ]; then
            echo "Unable to find a package named '${PACKAGE_NAME}' in organization '${ORG}'." >&2
            exit 1
          fi

          version_id="$(jq -r '.[0].id // empty' "$tmp_versions")"
          if [ -z "$version_id" ]; then
            echo "Package '${PACKAGE_NAME}' in '${ORG}' has no available versions." >&2
            exit 1
          fi

          tarball="package.tar.gz"
          gh api "/orgs/${ORG}/packages/${detected_type}/${PACKAGE_NAME}/versions/${version_id}/tarball" \
            --header "Accept: application/octet-stream" \
            --output "$tarball"

          bytes="$(stat -c%s "$tarball")"

          echo "Package type: $detected_type"
          echo "Latest version ID: $version_id"
          echo "Download path: $tarball"
          echo "Total bytes: $bytes"

